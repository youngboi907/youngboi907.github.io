<script>
  const depthLabels = [];
  const bidHistory = [];
  const askHistory = [];
  const maxDepthBars = 288;

  const depthChart = new Chart(document.getElementById("depthHistoryChart").getContext("2d"), {
    type: 'bar',
    data: {
      labels: depthLabels,
      datasets: [
        {
          label: 'Bid Volume (0-10%)',
          data: bidHistory,
          backgroundColor: 'rgba(0,255,0,0.6)',
          stack: 'stack'
        },
        {
          label: 'Ask Volume (0-10%)',
          data: askHistory,
          backgroundColor: 'rgba(255,0,0,0.6)',
          stack: 'stack'
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: { color: '#aaa', maxRotation: 45, minRotation: 45 }
        },
        y: {
          ticks: { color: '#aaa' },
          beginAtZero: true
        }
      },
      plugins: {
        legend: { labels: { color: '#fff' } }
      }
    }
  });

  async function fetchDepthSnapshot() {
    try {
      const res = await fetch("https://fapi.binance.com/fapi/v1/depth?symbol=BTCUSDT&limit=5000");
      const data = await res.json();
      const bids = data.bids.map(([p, q]) => ({ p: parseFloat(p), q: parseFloat(q) }));
      const asks = data.asks.map(([p, q]) => ({ p: parseFloat(p), q: parseFloat(q) }));
      const bestBid = bids[0].p;
      const bestAsk = asks[0].p;
      const mid = (bestBid + bestAsk) / 2;

      let totalBid = 0;
      let totalAsk = 0;

      for (let b of bids) {
        const pct = (mid - b.p) / mid;
        if (pct <= 0.1) totalBid += b.p * b.q;
      }

      for (let a of asks) {
        const pct = (a.p - mid) / mid;
        if (pct <= 0.1) totalAsk += a.p * a.q;
      }

      const timestamp = new Date();
      const label = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      depthLabels.push(label);
      bidHistory.push(parseFloat(totalBid.toFixed(2)));
      askHistory.push(parseFloat(totalAsk.toFixed(2)));

      if (depthLabels.length > maxDepthBars) {
        depthLabels.shift(); bidHistory.shift(); askHistory.shift();
      }

      depthChart.update();
    } catch (err) {
      console.error("Depth fetch error", err);
    }
  }

  function scheduleDepthUpdate() {
    const now = new Date();
    const delay = (5 - (now.getMinutes() % 5)) * 60 * 1000 - now.getSeconds() * 1000 - now.getMilliseconds();
    setTimeout(() => {
      fetchDepthSnapshot();
      setInterval(fetchDepthSnapshot, 5 * 60 * 1000);
    }, delay);
  }

  scheduleDepthUpdate();
  fetchDepthSnapshot(); // first fetch
</script>