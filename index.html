<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Previous head content remains the same] -->
</head>
<body>
    <!-- [Previous HTML content remains the same until the script section] -->

    <script>
        // [Previous configuration and variable declarations remain the same]

        function connectWebSocket() {
            loadingSpinner.style.display = 'block';
            connectionStatusEl.textContent = 'Connecting...';
            connectionStatusEl.className = 'disconnected';

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close();
            }

            const symbol = 'btcusdt';
            const streamName = `${symbol}@aggTrade`;
            
            // Use alternative endpoints for better connectivity
            const wsUrls = [
                `wss://stream.binance.com:9443/ws/${streamName}`,
                `wss://stream.binance.com:443/ws/${streamName}`,
                `wss://fstream.binance.com/ws/${streamName}`,
                `wss://fstream.binance.com:443/ws/${streamName}`
            ];

            let currentUrlIndex = 0;
            let retryCount = 0;
            const maxRetries = 5;
            const retryDelay = 3000;

            const tryConnect = () => {
                if (retryCount >= maxRetries) {
                    updateConnectionStatus('Failed to connect', false);
                    loadingSpinner.style.display = 'none';
                    return;
                }

                const wsUrl = currentMarket === 'spot' 
                    ? wsUrls[currentUrlIndex % 2]  // Use first two for spot
                    : wsUrls[2 + (currentUrlIndex % 2)];  // Use last two for futures

                console.log(`Attempting to connect to: ${wsUrl}`);
                websocket = new WebSocket(wsUrl);

                websocket.onopen = () => {
                    console.log('WebSocket connected to:', wsUrl);
                    isWebSocketConnected = true;
                    updateConnectionStatus('Connected', true);
                    loadingSpinner.style.display = 'none';
                    retryCount = 0;
                };

                websocket.onmessage = (event) => {
                    try {
                        const trade = JSON.parse(event.data);
                        handleNewTrade(trade);
                    } catch (e) {
                        console.error('Error processing message:', e);
                    }
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    isWebSocketConnected = false;
                    updateConnectionStatus(`Error (retry ${retryCount + 1}/${maxRetries})`, false);
                    currentUrlIndex++;
                    retryCount++;
                    setTimeout(tryConnect, retryDelay);
                };

                websocket.onclose = (event) => {
                    console.log('WebSocket closed:', event.code, event.reason);
                    isWebSocketConnected = false;
                    
                    if (!event.wasClean) {
                        updateConnectionStatus(`Reconnecting... (${retryCount + 1}/${maxRetries})`, false);
                        currentUrlIndex++;
                        retryCount++;
                        setTimeout(tryConnect, retryDelay);
                    }
                };
            };

            tryConnect();
        }

        // [Rest of the JavaScript code remains the same]

        // Add this to your existing init function
        function init() {
            setupEventListeners();
            setupCharts();
            // Start with a fresh connection
            resetData();
            connectWebSocket();
            startClock();
            setInterval(checkWindowBoundaries, 1000);
            
            // Add ping/pong to maintain connection
            setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    try {
                        websocket.send(JSON.stringify({ ping: Date.now() }));
                    } catch (e) {
                        console.log('Ping failed, reconnecting...');
                        connectWebSocket();
                    }
                }
            }, 30000); // Ping every 30 seconds
        }
    </script>
</body>
</html>