<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/USDT Taker Delta Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
            background-color: #f1f1f1;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .delta-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .timeframe-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        #loading-spinner {
            display: none;
        }
        #connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        .connected {
            background-color: #28a745;
            color: white;
        }
        .disconnected {
            background-color: #dc3545;
            color: white;
        }
        @media (max-width: 768px) {
            .delta-value {
                font-size: 1.2rem;
            }
            .stat-value {
                font-size: 1rem;
            }
            .btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center my-4">BTC/USDT Taker Delta Monitor</h1>
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="btn-group w-100">
                    <button class="btn btn-outline-primary market-btn active" data-market="spot">Spot</button>
                    <button class="btn btn-outline-primary market-btn" data-market="futures">Futures</button>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="btn-group w-100">
                    <button class="btn btn-outline-secondary timeframe-btn active" data-timeframe="5m">5m</button>
                    <button class="btn btn-outline-secondary timeframe-btn" data-timeframe="15m">15m</button>
                    <button class="btn btn-outline-secondary timeframe-btn" data-timeframe="1h">1h</button>
                    <button class="btn btn-outline-secondary timeframe-btn" data-timeframe="4h">4h</button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Current Taker Delta</div>
                    <div class="card-body text-center">
                        <div class="delta-value" id="current-delta">--</div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <div class="stat-value positive" id="delta-buy">--</div>
                                <div>Buy Volume</div>
                            </div>
                            <div class="col-6">
                                <div class="stat-value negative" id="delta-sell">--</div>
                                <div>Sell Volume</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Delta Extremes</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center">
                                <div class="stat-value positive" id="max-delta">--</div>
                                <div>Max Delta</div>
                                <small class="text-muted" id="time-max">--</small>
                            </div>
                            <div class="col-6 text-center">
                                <div class="stat-value negative" id="min-delta">--</div>
                                <div>Min Delta</div>
                                <small class="text-muted" id="time-min">--</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-end mt-3 text-muted" id="last-updated">
            Last updated: --
        </div>
        
        <div class="text-center mt-4" id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Fetching data...</p>
        </div>
        
        <div id="connection-status" class="disconnected">Disconnected</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        let currentMarket = 'spot';
        let currentTimeframe = '5m';
        let dataHistory = [];
        let websocket = null;
        let tradeData = [];
        let isWebSocketConnected = false;
        
        // DOM Elements
        const marketBtns = document.querySelectorAll('.market-btn');
        const timeframeBtns = document.querySelectorAll('.timeframe-btn');
        const currentDeltaEl = document.getElementById('current-delta');
        const deltaBuyEl = document.getElementById('delta-buy');
        const deltaSellEl = document.getElementById('delta-sell');
        const maxDeltaEl = document.getElementById('max-delta');
        const minDeltaEl = document.getElementById('min-delta');
        const timeMaxEl = document.getElementById('time-max');
        const timeMinEl = document.getElementById('time-min');
        const lastUpdatedEl = document.getElementById('last-updated');
        const loadingSpinner = document.getElementById('loading-spinner');
        const connectionStatusEl = document.getElementById('connection-status');
        
        // Event Listeners
        marketBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                marketBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMarket = btn.dataset.market;
                resetData();
                connectWebSocket();
            });
        });
        
        timeframeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                timeframeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTimeframe = btn.dataset.timeframe;
                processTradeData();
            });
        });
        
        // Functions
        function connectWebSocket() {
            // Close existing connection if any
            if (websocket) {
                websocket.close();
            }
            
            const symbol = 'btcusdt';
            const streamName = currentMarket === 'spot' 
                ? `${symbol}@aggTrade` 
                : `${symbol}@aggTrade`;
            
            const wsUrl = currentMarket === 'spot'
                ? `wss://stream.binance.com:9443/ws/${streamName}`
                : `wss://fstream.binance.com/ws/${streamName}`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = () => {
                console.log('WebSocket connected');
                isWebSocketConnected = true;
                connectionStatusEl.textContent = 'Connected';
                connectionStatusEl.className = 'connected';
                loadingSpinner.style.display = 'none';
            };
            
            websocket.onmessage = (event) => {
                const trade = JSON.parse(event.data);
                processNewTrade(trade);
            };
            
            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                isWebSocketConnected = false;
                connectionStatusEl.textContent = 'Connection Error';
                connectionStatusEl.className = 'disconnected';
                loadingSpinner.style.display = 'block';
                
                // Try to reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
            websocket.onclose = () => {
                console.log('WebSocket disconnected');
                isWebSocketConnected = false;
                connectionStatusEl.textContent = 'Disconnected';
                connectionStatusEl.className = 'disconnected';
                
                // Try to reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        function processNewTrade(trade) {
            // Add trade to our data array
            tradeData.push({
                timestamp: new Date(trade.T),
                isBuyerMaker: trade.m,
                quantity: parseFloat(trade.q),
                price: parseFloat(trade.p)
            });
            
            // Process the data to update our display
            processTradeData();
            
            // Update last updated time
            const now = new Date();
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }
        
        function processTradeData() {
            // Filter trades based on current timeframe
            const now = new Date();
            let cutoffTime = new Date(now);
            
            switch(currentTimeframe) {
                case '5m':
                    cutoffTime.setMinutes(now.getMinutes() - 5);
                    break;
                case '15m':
                    cutoffTime.setMinutes(now.getMinutes() - 15);
                    break;
                case '1h':
                    cutoffTime.setHours(now.getHours() - 1);
                    break;
                case '4h':
                    cutoffTime.setHours(now.getHours() - 4);
                    break;
            }
            
            const relevantTrades = tradeData.filter(trade => trade.timestamp >= cutoffTime);
            
            // Calculate buy/sell volumes and delta
            let buyVolume = 0;
            let sellVolume = 0;
            const deltaHistory = [];
            
            relevantTrades.forEach(trade => {
                const value = trade.quantity * trade.price;
                
                if (trade.isBuyerMaker) { // Taker was seller
                    sellVolume += value;
                } else { // Taker was buyer
                    buyVolume += value;
                }
                
                // Calculate delta at this point
                const total = buyVolume + sellVolume;
                const delta = total > 0 ? ((buyVolume - sellVolume) / total) * 100 : 0;
                
                deltaHistory.push({
                    timestamp: trade.timestamp,
                    delta: delta,
                    buyVolume: buyVolume,
                    sellVolume: sellVolume
                });
            });
            
            // Get current values (last trade in timeframe)
            const current = deltaHistory.length > 0 
                ? deltaHistory[deltaHistory.length - 1] 
                : { delta: 0, buyVolume: 0, sellVolume: 0, timestamp: now };
            
            // Calculate min/max delta
            let minDelta = 0;
            let maxDelta = 0;
            let timeMin = now;
            let timeMax = now;
            
            deltaHistory.forEach(item => {
                if (item.delta < minDelta) {
                    minDelta = item.delta;
                    timeMin = item.timestamp;
                }
                if (item.delta > maxDelta) {
                    maxDelta = item.delta;
                    timeMax = item.timestamp;
                }
            });
            
            // Update UI
            updateUI({
                current: current,
                extremes: {
                    minDelta: minDelta,
                    maxDelta: maxDelta,
                    timeMin: timeMin,
                    timeMax: timeMax
                }
            });
        }
        
        function updateUI(data) {
            // Current delta
            currentDeltaEl.textContent = formatDelta(data.current.delta);
            currentDeltaEl.className = `delta-value ${getDeltaClass(data.current.delta)}`;
            
            // Buy/sell volumes
            deltaBuyEl.textContent = formatNumber(data.current.buyVolume);
            deltaSellEl.textContent = formatNumber(data.current.sellVolume);
            
            // Extremes
            maxDeltaEl.textContent = formatDelta(data.extremes.maxDelta);
            minDeltaEl.textContent = formatDelta(data.extremes.minDelta);
            
            // Times
            timeMaxEl.textContent = formatTime(data.extremes.timeMax);
            timeMinEl.textContent = formatTime(data.extremes.timeMin);
        }
        
        function resetData() {
            tradeData = [];
            currentDeltaEl.textContent = '--';
            deltaBuyEl.textContent = '--';
            deltaSellEl.textContent = '--';
            maxDeltaEl.textContent = '--';
            minDeltaEl.textContent = '--';
            timeMaxEl.textContent = '--';
            timeMinEl.textContent = '--';
            lastUpdatedEl.textContent = 'Last updated: --';
        }
        
        function formatDelta(delta) {
            if (delta === null || delta === undefined) return '--';
            return (delta > 0 ? '+' : '') + delta.toFixed(2) + '%';
        }
        
        function formatNumber(num) {
            if (num === null || num === undefined) return '--';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }
        
        function formatTime(date) {
            if (!date) return '--';
            return date.toLocaleTimeString();
        }
        
        function getDeltaClass(delta) {
            if (delta > 0) return 'positive';
            if (delta < 0) return 'negative';
            return '';
        }
        
        // Initial load
        connectWebSocket();
    </script>
</body>
</html>